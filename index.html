<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">「もしも」の備えアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+KR:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans JP', 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-button {
            font-size: 0.875rem; /* 4 tabs might need smaller text */
        }
        .tab-button.active {
            border-color: #ef4444;
            background-color: #ef4444;
            color: white;
        }
        /* 震度スケール用のスタイル */
        .intensity-1 { background-color: #f0f4ff; border-left-color: #cddc39; }
        .intensity-2 { background-color: #e6f7ff; border-left-color: #4fc3f7; }
        .intensity-3 { background-color: #dcedc8; border-left-color: #29b6f6; }
        .intensity-4 { background-color: #fffbe6; border-left-color: #ffca28; }
        .intensity-5-minus { background-color: #fff3e0; border-left-color: #ffa726; }
        .intensity-5-plus { background-color: #ffccbc; border-left-color: #ff7043; }
        .intensity-6-minus { background-color: #fbe9e7; border-left-color: #ef5350; }
        .intensity-6-plus { background-color: #fce4ec; border-left-color: #d81b60; }
        .intensity-7 { background-color: #f3e5f5; border-left-color: #9c27b0; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-lg p-4 min-h-screen bg-white shadow-lg">

        <!-- Header -->
        <header class="relative text-center py-4 border-b-2 border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800" data-lang-key="appTitle">「もしも」の備えアプリ</h1>
            <p class="text-sm text-gray-500" data-lang-key="appSubtitle">公開APIで、あなたと大切な人を守る情報を届けます</p>
            <!-- Language Switcher -->
            <div class="absolute top-4 right-4">
                <div class="relative" id="lang-switcher-container">
                    <button id="current-lang-btn" class="flex items-center space-x-2 bg-gray-100 px-3 py-1.5 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.998 5.998 0 0116 10c0 .34-.028.675-.083 1H4.083A5.996 5.996 0 014 10c0-.339.028-.676.083-1.001a6.009 6.009 0 01.249-1.028zM8 12a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z" clip-rule="evenodd"></path></svg>
                        <span id="current-lang-text" class="w-4">JP</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <div id="lang-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-20 ring-1 ring-black ring-opacity-5">
                        <div class="py-1">
                            <a href="#" class="lang-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ja">日本語 (JP)</a>
                            <a href="#" class="lang-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English (EN)</a>
                            <a href="#" class="lang-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="ko">한국어 (KR)</a>
                            <a href="#" class="lang-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="zh">中文(简体) (CN)</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-around my-4">
            <button id="tab-alert" class="tab-button active flex-1 py-2 px-4 text-center font-semibold border-b-4 transition" data-lang-key="tabAlert">地震情報</button>
            <button id="tab-finder" class="tab-button flex-1 py-2 px-4 text-center font-semibold border-b-4 border-transparent text-gray-500 transition" data-lang-key="tabFinder">避難場所</button>
            <button id="tab-news" class="tab-button flex-1 py-2 px-4 text-center font-semibold border-b-4 border-transparent text-gray-500 transition" data-lang-key="tabNews">ニュース</button>
            <button id="tab-checklist" class="tab-button flex-1 py-2 px-4 text-center font-semibold border-b-4 border-transparent text-gray-500 transition" data-lang-key="tabChecklist">チェックリスト</button>
        </nav>

        <!-- Main Content -->
        <main id="content">
            <!-- Earthquake Info Page -->
            <div id="page-alert">
                 <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4" role="alert">
                    <p class="font-bold" data-lang-key="alertInfoTitle">地震情報</p>
                    <p data-lang-key="alertInfoDesc">設定した地域で揺れが観測された最新の地震情報を自動更新します。</p>
                </div>
                <div class="mt-4 px-1">
                    <label for="prefecture-selector" class="block text-sm font-medium text-gray-700 mb-1" data-lang-key="setPrefectureLabel">地域設定:</label>
                    <select id="prefecture-selector" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <!-- Status/Result Area -->
                <div class="mt-6 text-center">
                    <div id="alert-status" class="text-gray-600 h-6"></div>
                    <div id="alert-loader" class="hidden mx-auto mt-2 loader"></div>
                </div>
                <div id="alert-results" class="mt-4 space-y-4"></div>
            </div>

            <!-- Shelter Finder Page -->
            <div id="page-finder" class="hidden">
                 <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4">
                    <p class="font-bold" data-lang-key="finderInfoTitle">避難場所を探す</p>
                    <p data-lang-key="finderInfoDesc">現在地から最も近い避難場所を検索します。（デモデータ）</p>
                </div>
                <div class="mt-6 text-center">
                    <button id="findSheltersBtn" class="w-full max-w-xs bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform active:scale-95 text-lg">
                        <span data-lang-key="findSheltersBtn">検索開始</span>
                    </button>
                </div>
                <div id="shelter-status" class="mt-6 text-center text-gray-600"></div>
                <div id="shelter-loader" class="hidden mx-auto mt-6 loader"></div>
                <div id="shelter-results" class="mt-4 space-y-3"></div>
            </div>
            
            <!-- News Page -->
            <div id="page-news" class="hidden">
                 <div class="bg-green-50 border-l-4 border-green-500 text-green-800 p-4" role="alert">
                    <p class="font-bold" data-lang-key="newsInfoTitle">防災・気象ニュース</p>
                    <p data-lang-key="newsInfoDesc">NHKの最新ニュースを取得します。</p>
                </div>
                <div class="mt-6 text-center">
                    <button id="getNewsBtn" class="w-full max-w-xs bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-green-700 transition-transform transform active:scale-95 text-lg">
                        <span data-lang-key="getNewsBtn">ニュースを読み込む</span>
                    </button>
                </div>
                <div id="news-status" class="mt-6 text-center text-gray-600"></div>
                <div id="news-loader" class="hidden mx-auto mt-6 loader"></div>
                <div id="news-results" class="mt-4 space-y-3"></div>
            </div>

            <!-- Checklist Page -->
            <div id="page-checklist" class="hidden">
                 <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4">
                    <p class="font-bold" data-lang-key="checklistInfoTitle">防災チェックリスト</p>
                    <p data-lang-key="checklistInfoDesc">災害はいつ起こるか分かりません。日頃から準備をしておきましょう。</p>
                </div>
                <div id="checklist-container" class="mt-4 space-y-4 text-sm"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const contentPages = { alert: document.getElementById('page-alert'), finder: document.getElementById('page-finder'), news: document.getElementById('page-news'), checklist: document.getElementById('page-checklist') };
        const tabButtons = { alert: document.getElementById('tab-alert'), finder: document.getElementById('tab-finder'), news: document.getElementById('tab-news'), checklist: document.getElementById('tab-checklist') };
        
        const alertStatus = document.getElementById('alert-status');
        const alertLoader = document.getElementById('alert-loader');
        const alertResults = document.getElementById('alert-results');
        const prefectureSelector = document.getElementById('prefecture-selector');
        
        const findSheltersBtn = document.getElementById('findSheltersBtn');
        const shelterStatus = document.getElementById('shelter-status');
        const shelterLoader = document.getElementById('shelter-loader');
        const shelterResults = document.getElementById('shelter-results');
        
        const getNewsBtn = document.getElementById('getNewsBtn');
        const newsStatus = document.getElementById('news-status');
        const newsLoader = document.getElementById('news-loader');
        const newsResults = document.getElementById('news-results');

        const checklistContainer = document.getElementById('checklist-container');
        const langSwitcherContainer = document.getElementById('lang-switcher-container');
        const currentLangBtn = document.getElementById('current-lang-btn');
        const currentLangText = document.getElementById('current-lang-text');
        const langDropdown = document.getElementById('lang-dropdown');

        // --- Data ---
        const shelters = [
            { name: "習志野市立第一中学校", address: "千葉県習志野市泉町1-1-1", lat: 35.6853, lon: 140.0345, type: "学校" },
            { name: "津田沼公民館", address: "千葉県習志но市津田沼4-2-5", lat: 35.6920, lon: 140.0210, type: "公民館" },
            { name: "袖ケ浦東小学校", address: "千葉県習志野市袖ケ浦3-5-1", lat: 35.6698, lon: 140.0401, type: "学校" },
        ];
        
        const checklistData = {
            emergencyBag: ["water", "food", "valuables", "firstAid", "radio", "flashlight", "clothing", "gloves", "toilet"],
            homeStockpile: ["foodAndWater3Days", "stove", "waterForLife", "secureFurniture"]
        };
        
        const prefectures = [
            '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
            '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
            '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
            '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
            '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
            '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
            '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
        ];

        const translations = {
            ja: {
                pageTitle: "「もしも」の備えアプリ",
                appTitle: "「もしも」の備えアプリ",
                appSubtitle: "公開APIで、あなたと大切な人を守る情報を届けます",
                tabAlert: "地震情報",
                tabFinder: "避難場所",
                tabNews: "ニュース",
                tabChecklist: "チェックリスト",
                alertInfoTitle: "地震情報",
                alertInfoDesc: "設定した地域で揺れが観測された最新の地震情報を自動更新します。",
                setPrefectureLabel: "地域設定:",
                finderInfoTitle: "避難場所を探す",
                finderInfoDesc: "現在地から最も近い避難場所を検索します。（デモデータ）",
                findSheltersBtn: "検索開始",
                newsInfoTitle: "防災・気象ニュース",
                newsInfoDesc: "NHKの最新ニュースを取得します。",
                getNewsBtn: "ニュースを読み込む",
                checklistInfoTitle: "防災チェックリスト",
                checklistInfoDesc: "災害はいつ起こるか分かりません。日頃から準備をしておきましょう。",
                gettingLocation: "位置情報を取得しています...",
                findingShelters: "近くの避難場所を検索しています...",
                searchComplete: "検索が完了しました。",
                locationPermissionError: "位置情報の利用を許可してください。",
                gettingAlerts: "最新の地震情報を取得しています...",
                alertsError: "情報取得に失敗しました。",
                noRecentEarthquakeInPref: "現在、{pref}内で観測された新しい地震情報はありません。",
                lastUpdated: "最終更新",
                localIntensityLabel: "あなたの地域（{pref}）の震度",
                gettingNews: "最新ニュースを取得しています...",
                newsUpdated: "ニュースを更新しました。",
                newsError: "ニュースの取得に失敗しました。",
                distance: "現在地からの距離:",
                shelterTypeSchool: "学校",
                shelterTypeHall: "公民館",
                openMap: "地図で開く",
                emergencyBag: "非常用持ち出し袋",
                water: "飲料水（1人1日3リットルが目安）",
                food: "食料品（カップ麺、缶詰など）",
                valuables: "貴重品（現金、保険証など）",
                firstAid: "救急用品",
                radio: "携帯ラジオ、予備電池",
                flashlight: "懐中電灯",
                clothing: "衣類、下着",
                gloves: "軍手、マスク",
                toilet: "携帯トイレ",
                homeStockpile: "自宅での備蓄",
                foodAndWater3Days: "最低3日分（できれば1週間分）の食料と水",
                stove: "カセットコンロ、ボンベ",
                waterForLife: "生活用水（お風呂の水をためておくなど）",
                secureFurniture: "家具の転倒防止対策",
                earthquakeInfo: "地震情報",
                occurrenceTime: "発生時刻",
                epicenter: "震源地",
                maxIntensity: "最大震度",
                magnitude: "マグニチュード",
            },
            en: {
                pageTitle: "Disaster Preparedness App",
                appTitle: "Disaster Preparedness App",
                appSubtitle: "Delivering information to protect you and your loved ones with Public APIs",
                tabAlert: "Earthquake",
                tabFinder: "Shelters",
                tabNews: "News",
                tabChecklist: "Checklist",
                alertInfoTitle: "Earthquake Information",
                alertInfoDesc: "Automatically updates with the latest earthquake information observed in your selected prefecture.",
                setPrefectureLabel: "Set Prefecture:",
                finderInfoTitle: "Find Shelters",
                finderInfoDesc: "Finds the nearest evacuation shelters from your current location. (Demo Data)",
                findSheltersBtn: "Start Search",
                newsInfoTitle: "Disaster & Weather News",
                newsInfoDesc: "Fetches the latest news from NHK.",
                getNewsBtn: "Load News",
                checklistInfoTitle: "Disaster Checklist",
                checklistInfoDesc: "Disasters can happen at any time. Let's be prepared.",
                gettingLocation: "Getting your location...",
                findingShelters: "Finding nearby shelters...",
                searchComplete: "Search complete.",
                locationPermissionError: "Please allow location access.",
                gettingAlerts: "Getting the latest earthquake information...",
                alertsError: "Failed to get information.",
                noRecentEarthquakeInPref: "No new earthquakes have been observed in {pref}.",
                lastUpdated: "Last Updated",
                localIntensityLabel: "Intensity in your area ({pref})",
                gettingNews: "Fetching latest news...",
                newsUpdated: "News updated.",
                newsError: "Failed to fetch news.",
                distance: "Distance from you:",
                shelterTypeSchool: "School",
                shelterTypeHall: "Community Center",
                openMap: "Open in Map",
                emergencyBag: "Emergency Bag",
                water: "Drinking water (3 liters per person per day)",
                food: "Emergency food (instant noodles, canned goods, etc.)",
                valuables: "Valuables (cash, insurance card, etc.)",
                firstAid: "First-aid kit",
                radio: "Portable radio, spare batteries",
                flashlight: "Flashlight",
                clothing: "Clothes, underwear",
                gloves: "Work gloves, masks",
                toilet: "Portable toilet",
                homeStockpile: "Home Stockpile",
                foodAndWater3Days: "At least 3 days' worth of food and water (1 week recommended)",
                stove: "Portable stove, gas canisters",
                waterForLife: "Water for daily life (e.g., store water in the bathtub)",
                secureFurniture: "Measures to prevent furniture from overturning",
                earthquakeInfo: "Earthquake Info",
                occurrenceTime: "Time",
                epicenter: "Epicenter",
                maxIntensity: "Max Intensity",
                magnitude: "Magnitude",
            },
            ko: {
                pageTitle: "재해 대비 앱",
                appTitle: "재해 대비 앱",
                appSubtitle: "공개 API로 당신과 소중한 사람을 지키는 정보를 전달합니다",
                tabAlert: "지진 정보",
                tabFinder: "대피소",
                tabNews: "뉴스",
                tabChecklist: "체크리스트",
                alertInfoTitle: "지진 정보",
                alertInfoDesc: "설정한 지역에서 관측된 최신 지진 정보를 자동 업데이트합니다.",
                setPrefectureLabel: "지역 설정:",
                finderInfoTitle: "대피소 찾기",
                finderInfoDesc: "현재 위치에서 가장 가까운 대피소를 검색합니다. (데모 데이터)",
                findSheltersBtn: "검색 시작",
                newsInfoTitle: "재해·기상 뉴스",
                newsInfoDesc: "NHK의 최신 뉴스를 가져옵니다.",
                getNewsBtn: "뉴스 불러오기",
                checklistInfoTitle: "재해 체크리스트",
                checklistInfoDesc: "재해는 언제 일어날지 모릅니다. 평소에 준비해 둡시다.",
                gettingLocation: "위치 정보를 가져오는 중...",
                findingShelters: "가까운 대피소를 검색하는 중...",
                searchComplete: "검색이 완료되었습니다.",
                locationPermissionError: "위치 정보 접근을 허용해 주세요.",
                gettingAlerts: "최신 지진 정보를 가져오는 중...",
                alertsError: "정보를 가져오지 못했습니다.",
                noRecentEarthquakeInPref: "현재 {pref}에서 관측된 새로운 지진 정보가 없습니다.",
                lastUpdated: "마지막 업데이트",
                localIntensityLabel: "현재 지역({pref})의 진도",
                gettingNews: "최신 뉴스를 가져오는 중...",
                newsUpdated: "뉴스가 업데이트되었습니다.",
                newsError: "뉴스 가져오기에 실패했습니다.",
                distance: "현재 위치로부터의 거리:",
                shelterTypeSchool: "학교",
                shelterTypeHall: "공민관",
                openMap: "지도로 열기",
                emergencyBag: "비상용 배낭",
                water: "식수 (1인당 하루 3리터 기준)",
                food: "식료품 (컵라면, 통조림 등)",
                valuables: "귀중품 (현금, 보험증 등)",
                firstAid: "구급용품",
                radio: "휴대용 라디오, 예비 배터리",
                flashlight: "손전등",
                clothing: "의류, 속옷",
                gloves: "작업용 장갑, 마스크",
                toilet: "휴대용 화장실",
                homeStockpile: "가정 비축",
                foodAndWater3Days: "최소 3일분(가능하면 1주일분)의 식량과 물",
                stove: "휴대용 가스레인지, 부탄가스",
                waterForLife: "생활용수 (욕조에 물을 받아두는 등)",
                secureFurniture: "가구 전도 방지 대책",
                earthquakeInfo: "지진 정보",
                occurrenceTime: "발생 시각",
                epicenter: "진원지",
                maxIntensity: "최대 진도",
                magnitude: "규모",
            },
            zh: {
                pageTitle: "防灾应用",
                appTitle: "防灾应用",
                appSubtitle: "通过公共API提供保护您和您亲人的信息",
                tabAlert: "地震信息",
                tabFinder: "避难所",
                tabNews: "新闻",
                tabChecklist: "清单",
                alertInfoTitle: "地震信息",
                alertInfoDesc: "自动更新您所选地区观测到的最新地震信息。",
                setPrefectureLabel: "地区设置:",
                finderInfoTitle: "寻找避难所",
                finderInfoDesc: "从您当前位置搜索最近的避难所。（演示数据）",
                findSheltersBtn: "开始搜索",
                newsInfoTitle: "防灾·气象新闻",
                newsInfoDesc: "获取NHK的最新新闻。",
                getNewsBtn: "加载新闻",
                checklistInfoTitle: "防灾清单",
                checklistInfoDesc: "灾难随时可能发生。让我们做好准备。",
                gettingLocation: "正在获取您的位置...",
                findingShelters: "正在搜索附近的避难所...",
                searchComplete: "搜索完成。",
                locationPermissionError: "请允许位置访问。",
                gettingAlerts: "正在获取最新的地震信息...",
                alertsError: "获取信息失败。",
                noRecentEarthquakeInPref: "目前在{pref}没有观测到新的地震信息。",
                lastUpdated: "最后更新",
                localIntensityLabel: "您所在地区({pref})的震度",
                gettingNews: "正在获取最新新闻...",
                newsUpdated: "新闻已更新。",
                newsError: "获取新闻失败。",
                distance: "距您当前位置的距离:",
                shelterTypeSchool: "学校",
                shelterTypeHall: "公民馆",
                openMap: "在地图中打开",
                emergencyBag: "应急包",
                water: "饮用水（每人每天3升）",
                food: "应急食品（方便面、罐头等）",
                valuables: "贵重物品（现金、保险卡等）",
                firstAid: "急救箱",
                radio: "便携式收音机、备用电池",
                flashlight: "手电筒",
                clothing: "衣物、内衣",
                gloves: "工作手套、口罩",
                toilet: "便携式厕所",
                homeStockpile: "家庭储备",
                foodAndWater3Days: "至少3天的食物和水（建议1周）",
                stove: "便携式炉灶、燃气罐",
                waterForLife: "生活用水（例如，在浴缸中存水）",
                secureFurniture: "防止家具倾倒的措施",
                earthquakeInfo: "地震信息",
                occurrenceTime: "发生时间",
                epicenter: "震中",
                maxIntensity: "最大震度",
                magnitude: "震级",
            }
        };

        let currentLanguage = 'ja';
        let earthquakeUpdateInterval;

        // --- Event Listeners ---
        Object.keys(tabButtons).forEach(key => tabButtons[key].addEventListener('click', () => switchTab(key)));
        findSheltersBtn.addEventListener('click', getUserLocation);
        getNewsBtn.addEventListener('click', fetchNews);
        prefectureSelector.addEventListener('change', handlePrefectureChange);

        currentLangBtn.addEventListener('click', () => {
            langDropdown.classList.toggle('hidden');
        });

        langDropdown.addEventListener('click', e => {
            e.preventDefault();
            if (e.target.matches('.lang-option')) {
                const lang = e.target.getAttribute('data-lang');
                changeLanguage(lang);
                langDropdown.classList.add('hidden');
            }
        });

        document.addEventListener('click', e => {
            if (!langSwitcherContainer.contains(e.target)) {
                langDropdown.classList.add('hidden');
            }
        });
        document.addEventListener('DOMContentLoaded', initializeApp);


        // --- Functions ---
        
        function initializeApp() {
            populatePrefectureSelector();
            const savedLang = localStorage.getItem('appLanguage') || 'ja';
            changeLanguage(savedLang);
            renderChecklist();
            switchTab('alert');
        }
        
        function populatePrefectureSelector() {
            const savedPrefecture = localStorage.getItem('userPrefecture') || '東京都';
            prefectures.forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                if (pref === savedPrefecture) {
                    option.selected = true;
                }
                prefectureSelector.appendChild(option);
            });
        }
        
        function handlePrefectureChange(event) {
            const selectedPrefecture = event.target.value;
            localStorage.setItem('userPrefecture', selectedPrefecture);
            fetchEarthquakeInfo();
        }

        function switchTab(tabKey) {
            Object.values(tabButtons).forEach(btn => btn.classList.remove('active'));
            Object.values(contentPages).forEach(page => page.classList.add('hidden'));
            tabButtons[tabKey].classList.add('active');
            contentPages[tabKey].classList.remove('hidden');

            if (tabKey === 'alert') {
                fetchEarthquakeInfo(); 
                if (!earthquakeUpdateInterval) {
                   earthquakeUpdateInterval = setInterval(fetchEarthquakeInfo, 60000);
                }
            } else {
                clearInterval(earthquakeUpdateInterval);
                earthquakeUpdateInterval = null;
            }
        }
        
        function changeLanguage(lang) {
            if (!translations[lang]) return;
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                const translation = translations[lang][key];
                if(translation) el.textContent = translation;
            });
            
            currentLangText.textContent = lang.toUpperCase();
            renderChecklist();
        }

        function renderChecklist() {
            let checklistHTML = '';
            const lang = currentLanguage;

            checklistHTML += `<h3 class="text-lg font-bold text-gray-800">${translations[lang].emergencyBag}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">`;
            checklistData.emergencyBag.forEach(item => {
                checklistHTML += `<label class="flex items-center p-3 bg-gray-50 rounded-lg"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">${translations[lang][item]}</label>`;
            });
            checklistHTML += `</div>`;
            
            checklistHTML += `<h3 class="text-lg font-bold text-gray-800 mt-6">${translations[lang].homeStockpile}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">`;
            checklistData.homeStockpile.forEach(item => {
                checklistHTML += `<label class="flex items-center p-3 bg-gray-50 rounded-lg"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3">${translations[lang][item]}</label>`;
            });
            checklistHTML += `</div>`;

            checklistContainer.innerHTML = checklistHTML;
        }

        // --- News Functions ---
        async function fetchNews() {
            newsStatus.textContent = translations[currentLanguage].gettingNews;
            newsLoader.classList.remove('hidden');
            newsResults.innerHTML = '';
            getNewsBtn.disabled = true;

            const rssFeedUrl = 'https://www.nhk.or.jp/rss/news/cat5.xml';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `${proxyUrl}${encodeURIComponent(rssFeedUrl)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const xmlString = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                const items = xmlDoc.querySelectorAll("item");
                
                if (items.length > 0) {
                     const newsItems = Array.from(items).map(item => ({
                        title: item.querySelector("title")?.textContent || '',
                        link: item.querySelector("link")?.textContent || '',
                        pubDate: item.querySelector("pubDate")?.textContent || '',
                    }));
                    displayNews(newsItems);
                    newsStatus.textContent = translations[currentLanguage].newsUpdated;
                } else {
                    throw new Error('No news items found in RSS feed.');
                }

            } catch (error) {
                console.error("Error fetching news data:", error);
                newsStatus.textContent = translations[currentLanguage].newsError;
                newsResults.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong>Error:</strong><span class="block sm:inline">${error.message}</span></div>`;
            } finally {
                newsLoader.classList.add('hidden');
                getNewsBtn.disabled = false;
            }
        }

        function displayNews(items) {
            newsResults.innerHTML = '';
            items.slice(0, 10).forEach(item => {
                const card = document.createElement('a');
                card.className = "block p-4 bg-white border rounded-lg shadow-sm hover:bg-gray-50 transition";
                card.href = item.link;
                card.target = "_blank";
                card.rel = "noopener noreferrer";

                const pubDate = new Date(item.pubDate).toLocaleString(currentLanguage, {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                card.innerHTML = `
                    <h3 class="font-bold text-md text-gray-800">${item.title}</h3>
                    <p class="text-xs text-gray-500 mt-2">${pubDate}</p>
                `;
                newsResults.appendChild(card);
            });
        }


        // --- Earthquake Info Functions ---
        async function fetchEarthquakeInfo() {
            if (!alertResults.innerHTML && !alertStatus.textContent) {
                 alertStatus.textContent = translations[currentLanguage].gettingAlerts;
                 alertLoader.classList.remove('hidden');
            }
            
            const apiUrl = 'https://api.p2pquake.net/v2/history?codes=551&limit=20';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                
                const userPrefecture = localStorage.getItem('userPrefecture') || '東京都';
                let relevantEarthquake = null;
                let localPoint = null;

                for (const eq of data) {
                    const point = eq.points.find(p => p.pref === userPrefecture && p.scale >= 10);
                    if (point) {
                        relevantEarthquake = eq;
                        localPoint = point;
                        break; 
                    }
                }
                
                alertResults.innerHTML = ''; 
                if (relevantEarthquake) {
                    displayEarthquakeInfo(relevantEarthquake, localPoint);
                } else {
                    alertResults.innerHTML = `<p class="text-center">${translations[currentLanguage].noRecentEarthquakeInPref.replace('{pref}', userPrefecture)}</p>`;
                }
                const now = new Date();
                alertStatus.textContent = `${translations[currentLanguage].lastUpdated}: ${now.toLocaleTimeString(currentLanguage)}`;

            } catch (error) {
                console.error("Error fetching earthquake data:", error);
                alertStatus.textContent = translations[currentLanguage].alertsError;
            } finally {
                alertLoader.classList.add('hidden');
            }
        }
        
        function displayEarthquakeInfo(eq, localPoint) {
             const eqData = {
                time: new Date(eq.time).toLocaleString(currentLanguage),
                hypocenter: eq.earthquake.hypocenter.name,
                maxScale: eq.earthquake.maxScale,
                magnitude: eq.earthquake.hypocenter.magnitude,
            };

            const scaleToText = {
                '10': '1', '20': '2', '30': '3', '40': '4', '45': '5弱', '50': '5強', '55': '6弱', '60': '6強', '70': '7'
            };
            const maxIntensityText = scaleToText[eqData.maxScale] || '不明';
            const localIntensityText = scaleToText[localPoint.scale] || '不明';
            
            const getIntensityClass = (scale) => {
                if (scale >= 70) return 'intensity-7';
                if (scale >= 60) return 'intensity-6-plus';
                if (scale >= 55) return 'intensity-6-minus';
                if (scale >= 50) return 'intensity-5-plus';
                if (scale >= 45) return 'intensity-5-minus';
                if (scale >= 40) return 'intensity-4';
                if (scale >= 30) return 'intensity-3';
                if (scale >= 20) return 'intensity-2';
                return 'intensity-1';
            };

            const cardClass = getIntensityClass(localPoint.scale); // Color card based on local intensity
            
            const card = document.createElement('div');
            card.className = `border-l-8 rounded-lg p-4 shadow ${cardClass}`;
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-600">${translations[currentLanguage].occurrenceTime}</p>
                        <p class="font-bold text-lg">${eqData.time}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">${translations[currentLanguage].maxIntensity}</p>
                        <p class="font-bold text-3xl text-red-600">${maxIntensityText}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600">${translations[currentLanguage].epicenter}</p>
                    <p class="font-semibold text-lg">${eqData.hypocenter}</p>
                </div>
                <div class="mt-2">
                    <p class="text-sm text-gray-600">${translations[currentLanguage].magnitude}</p>
                    <p class="font-semibold text-lg">M ${eqData.magnitude}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-sm font-semibold text-blue-800">${translations[currentLanguage].localIntensityLabel.replace('{pref}', localPoint.pref)}</p>
                    <div class="flex items-baseline space-x-2">
                         <p class="font-bold text-2xl text-blue-700">${localIntensityText}</p>
                         <p class="text-sm text-gray-600">${localPoint.addr}</p>
                    </div>
                </div>
            `;
            alertResults.appendChild(card);
        }

        // --- Shelter Finder Functions ---
        function getUserLocation() {
            shelterStatus.textContent = translations[currentLanguage].gettingLocation;
            shelterLoader.classList.remove('hidden');
            shelterResults.innerHTML = '';
            findSheltersBtn.disabled = true;

            if (!navigator.geolocation) {
                shelterStatus.textContent = "Geolocation is not supported by your browser";
                shelterLoader.classList.add('hidden');
                findSheltersBtn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    shelterStatus.textContent = translations[currentLanguage].findingShelters;
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    findNearestShelters(userLat, userLon);
                },
                () => {
                    shelterStatus.textContent = translations[currentLanguage].locationPermissionError;
                    shelterLoader.classList.add('hidden');
                    findSheltersBtn.disabled = false;
                }
            );
        }

        function findNearestShelters(userLat, userLon) {
            const sortedShelters = shelters.map(shelter => {
                const distance = getDistance(userLat, userLon, shelter.lat, shelter.lon);
                return { ...shelter, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            displayShelters(sortedShelters.slice(0, 5));
            shelterStatus.textContent = translations[currentLanguage].searchComplete;
            shelterLoader.classList.add('hidden');
            findSheltersBtn.disabled = false;
        }

        function displayShelters(sheltersToShow) {
            shelterResults.innerHTML = '';
            sheltersToShow.forEach(shelter => {
                const shelterTypeKey = shelter.type === "学校" ? "shelterTypeSchool" : "shelterTypeHall";
                const shelterType = translations[currentLanguage][shelterTypeKey] || shelter.type;
                
                const card = document.createElement('div');
                card.className = "p-4 bg-white border rounded-lg shadow-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-blue-800">${shelter.name}</h3>
                        <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${shelterType}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">${shelter.address}</p>
                    <p class="text-sm font-medium text-gray-700 mt-2">${translations[currentLanguage].distance} <span class="font-bold">${shelter.distance.toFixed(2)} km</span></p>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${shelter.lat},${shelter.lon}" target="_blank" rel="noopener noreferrer" class="inline-block mt-3 bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600 transition">
                        ${translations[currentLanguage].openMap}
                    </a>
                `;
                shelterResults.appendChild(card);
            });
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180)
        }
    </script>
</body>
</html>


